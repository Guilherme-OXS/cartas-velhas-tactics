<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="description" content="Cartas Velhas: Cyberpunk Tactics.">
    <title>Cartas Velhas: Cyberpunk Tactics v0.9.27</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');

        /* --- CORE STYLES --- */
        body { 
            margin: 0; overflow: hidden; background-color: #050510; 
            font-family: 'Rajdhani', sans-serif; 
            user-select: none; touch-action: none; color: #fff;
        }
        
        /* Efeitos de Tela (Scanlines) */
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 900; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10; }
        .pointer-events-auto { pointer-events: auto; }

        :root { --x-color: #ff0055; --o-color: #00e5ff; --bg-dark: rgba(10, 15, 20, 0.95); }

        /* --- TELAS --- */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; transition: opacity 0.5s; opacity: 1; visibility: visible; display:flex; flex-direction:column; justify-content:center; align-items:center;}
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; transition: 0.5s; }

        /* TELA DE LOGIN (Centralizada) */
        #screen-login { background: radial-gradient(circle, rgba(0,0,0,0.8), #000); }
        
        /* TELA DE MENU (Lateral - NOVO VISUAL) */
        #screen-menu { 
            align-items: flex-start; /* Alinha √† esquerda */
            justify-content: center; 
            padding-left: 5%; 
            background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        }

        /* --- COMPONENTES --- */
        
        /* Painel Padr√£o (Para modais, perfil, etc) */
        .cyber-panel {
            background: var(--bg-dark); border: 1px solid #333; border-top: 4px solid var(--o-color);
            padding: 30px; max-width: 500px; width: 90%; position: relative; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            clip-path: polygon(0 0, 100% 0, 100% 95%, 95% 100%, 0 100%);
        }

        /* Menu Lateral Container */
        .menu-sidebar {
            display: flex; flex-direction: column; gap: 15px; width: 280px;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* T√≠tulos */
        .title-glitch { 
            font-size: 4rem; font-weight: 700; color: #fff; line-height: 0.9; 
            text-shadow: 4px 4px 0px var(--x-color); margin-bottom: 30px; text-transform: uppercase;
            letter-spacing: 5px;
        }
        
        /* Bot√µes Estilizados */
        .cyber-btn { 
            background: rgba(0, 229, 255, 0.1); border: 1px solid var(--o-color); color: var(--o-color); 
            padding: 12px 20px; font-size: 1rem; font-weight: bold; letter-spacing: 2px; cursor: pointer; 
            text-transform: uppercase; width: 100%; text-align: left;
            position: relative; overflow: hidden; transition: 0.2s;
            clip-path: polygon(0 0, 100% 0, 100% 80%, 95% 100%, 0 100%);
        }
        .cyber-btn:hover { background: var(--o-color); color: #000; padding-left: 30px; }
        .cyber-btn::before { content: "‚ñ∫"; margin-right: 10px; font-size: 0.8rem; opacity: 0.5; }
        
        .cyber-btn.secondary { border-color: #444; color: #aaa; background: rgba(0,0,0,0.5); }
        .cyber-btn.secondary:hover { border-color: #fff; color: #fff; background: #333; }
        
        .cyber-btn.google-btn { border-color: #4285F4; color: #4285F4; text-align: center; }
        .cyber-btn.google-btn:hover { background: #4285F4; color: #fff; padding-left: 20px; }

        /* Perfil no Menu */
        .menu-profile {
            display: flex; align-items: center; gap: 15px; padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 10px;
        }
        .menu-avatar { width: 60px; height: 60px; border: 2px solid var(--o-color); object-fit: cover; }
        .menu-user-info h3 { margin: 0; font-size: 1.2rem; color: #fff; text-transform: uppercase; }
        .menu-user-info span { font-size: 0.8rem; color: var(--o-color); }

        /* Inputs */
        .input-code { background: rgba(0,0,0,0.5); border: 1px solid #555; padding: 12px; font-size: 1.2rem; color: #fff; text-align: center; letter-spacing: 3px; text-transform: uppercase; width: 220px; outline: none; display:block; margin: 10px auto;}
        
        /* Listas e Scroll */
        .scroll-content {
            max-height: 50vh; overflow-y: auto; padding-right: 15px; text-align: left;
            scrollbar-width: thin; scrollbar-color: var(--o-color) #111;
        }
        .ranking-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .ranking-row:hover { background: rgba(255,255,255,0.05); }
        
        /* Loader */
        .loader { border: 4px solid #333; border-top: 4px solid var(--o-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Toast */
        #toast-msg { position: absolute; top: 40%; width: 100%; text-align: center; font-size: 3rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--x-color); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200; transform: scale(0.5); }
        #toast-msg.show { transform: scale(1); opacity: 1; }

        /* Game HUD Elements (mantidos do original) */
        .scores { display: flex; gap: 30px; margin-top: 5px; align-items: center; justify-content: center; width: 100%; }
        .player-score { opacity: 0.5; transform: scale(0.9); transition: 0.3s; text-align: center; }
        .player-score.active-turn { opacity: 1; transform: scale(1.1); text-shadow: 0 0 15px currentColor; }
        .score-val { font-size: 2.5rem; font-weight: bold; }
        .timer-bar { width: 100%; height: 4px; background: var(--o-color); margin-top: 15px; max-width: 300px; box-shadow: 0 0 10px var(--o-color); }
        .hand-wrapper { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; z-index: 10; }
        .hand-container { display: flex; gap: 10px; padding: 10px; }
        .card { width: 80px; height: 110px; background: rgba(10,10,20,0.9); border: 1px solid #444; border-top: 3px solid #666; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.2s; cursor:pointer; }
        .card:hover { transform: translateY(-15px); border-color: #fff; z-index: 50; }
        .card.selected { transform: translateY(-25px); border-color: var(--o-color); box-shadow: 0 0 15px var(--o-color); }
        .card-icon { font-size: 2rem; }
        .card-name { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        #hint-pill { position: absolute; top: 120px; background: rgba(0,0,0,0.8); border: 1px solid var(--o-color); padding: 5px 15px; opacity: 0; transition: 0.3s; pointer-events: none; }
        #hint-pill.active { transform: translateY(0); opacity: 1; }

        /* Stats Grid */
        .stats-grid { display: flex; gap: 10px; margin-top: 20px; }
        .stat-box { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; }
        .stat-label { font-size: 0.7rem; color: #aaa; }

    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%;"></div>

    <div id="screen-login" class="screen">
        <div style="text-align: center;">
            <div class="title-glitch">CARTAS<br>VELHAS</div>
            <p style="letter-spacing: 5px; color: var(--o-color); margin-bottom: 40px; font-size: 1rem;">TACTICAL OS v0.9.27</p>
            <div class="cyber-panel" style="background:transparent; border:none; box-shadow:none;">
                <button class="cyber-btn google-btn" onclick="loginGoogle()"><span>LOGIN COM GOOGLE</span></button>
            </div>
        </div>
    </div>

    <div id="screen-nickname" class="screen hidden">
        <div class="cyber-panel">
            <h2 style="color:var(--o-color);">REGISTO DE OPERADOR</h2>
            <p style="color:#ccc; font-size:0.9rem; margin-bottom:20px;">IDENTIFICA√á√ÉO NECESS√ÅRIA PARA ACESSO AO SISTEMA</p>
            <input type="text" id="initial-nick-input" class="input-code" maxlength="10" placeholder="SEU NICKNAME">
            <br>
            <button class="cyber-btn" onclick="saveInitialNickname()"><span>REGISTRAR</span></button>
        </div>
    </div>

    <div id="screen-menu" class="screen hidden">
        <div class="menu-sidebar">
            <div class="menu-profile">
                <img id="menu-avatar" class="menu-avatar" src="" alt="Avatar">
                <div class="menu-user-info">
                    <h3 id="menu-nick">Player</h3>
                    <span id="menu-status" class="user-status">CONECTADO</span>
                </div>
            </div>

            <button class="cyber-btn" onclick="startQuickMatch()">PARTIDA R√ÅPIDA</button>
            <button class="cyber-btn" onclick="startBotMatch()">TREINO VS BOT</button>
            
            <div style="height: 20px;"></div> <button class="cyber-btn secondary" onclick="openScreen('screen-profile')">MEU PERFIL</button>
            <button class="cyber-btn secondary" onclick="openScreen('screen-social')">BUSCA SOCIAL</button>
            <button class="cyber-btn secondary" onclick="openScreen('screen-leaderboard')">RANKING GLOBAL</button>
            
            <div style="height: 20px;"></div> <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <button class="cyber-btn secondary" style="font-size:0.7rem;" onclick="openScreen('screen-lobby-custom')">SALAS</button>
                <button class="cyber-btn secondary" style="font-size:0.7rem;" onclick="openScreen('screen-cards')">AJUDA</button>
            </div>
            <button class="cyber-btn secondary" style="border-color:#ff0055; color:#ff0055;" onclick="logout()">DESCONECTAR</button>
        </div>
    </div>

    <div id="screen-profile" class="screen hidden">
        <div class="cyber-panel">
            <h2 style="color:#fff;">DADOS DO OPERADOR</h2>
            <img id="detail-profile-img" class="menu-avatar" style="width:100px; height:100px; margin: 0 auto 15px auto;" src="">
            
            <div style="margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px;">
                <label style="color:#aaa; font-size:0.7rem;">ALTERAR CODINOME</label>
                <div style="display:flex; justify-content:center; gap:5px; margin-top:5px;">
                    <input type="text" id="edit-nick-input" class="input-code" style="width: 180px; margin:0;" maxlength="10">
                    <button class="cyber-btn secondary" style="min-width:auto; padding:10px 15px;" onclick="saveNewNickname()">üíæ</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box" style="border-color:#bd00ff;"><div class="stat-val" id="stat-rank" style="color:#bd00ff;">-</div><div class="stat-label">ELO</div></div>
                <div class="stat-box" style="border-color:#00ff88;"><div class="stat-val" id="stat-wins" style="color:#00ff88;">-</div><div class="stat-label">VIT√ìRIAS</div></div>
                <div class="stat-box" style="border-color:#ff0055;"><div class="stat-val" id="stat-losses" style="color:#ff0055;">-</div><div class="stat-label">DERROTAS</div></div>
            </div>
            <br>
            <button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-social" class="screen hidden">
        <div class="cyber-panel">
            <h2>REDE NEURAL</h2>
            <input type="text" id="search-player-input" class="input-code" placeholder="NICK EXATO">
            <button class="cyber-btn" style="width:auto; display:inline-block; min-width:150px;" onclick="searchPlayer()">BUSCAR</button>
            <div id="search-results-area" class="scroll-content" style="margin-top:20px; height: 250px; background:rgba(0,0,0,0.3);"></div>
            <br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-leaderboard" class="screen hidden">
        <div class="cyber-panel">
            <h2 style="color:#bd00ff;">TOP 100 ELITE</h2>
            <div id="leaderboard-list" class="scroll-content" style="height: 350px;"></div>
            <br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-cards" class="screen hidden">
        <div class="cyber-panel">
            <h2>MANUAL T√ÅTICO</h2>
            <div class="scroll-content" id="cards-list-ui"></div>
            <br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-lobby-custom" class="screen hidden">
        <div class="cyber-panel">
            <h2>SALA PRIVADA</h2>
            <button class="cyber-btn" onclick="openLobby('host')">CRIAR SALA</button>
            <button class="cyber-btn" onclick="openLobby('join')">ENTRAR C/ C√ìDIGO</button>
            <br><br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-lobby-wait" class="screen hidden">
        <div class="cyber-panel">
            <h2>LOBBY</h2>
            <div id="lobby-host-ui" class="hidden">
                <p>C√ìDIGO DE ACESSO</p>
                <div id="display-code" class="input-code" style="border:none; cursor:pointer; font-size:2rem; color:var(--o-color);" onclick="copyCode()">...</div>
                <p class="loader"></p>
            </div>
            <div id="lobby-client-ui" class="hidden">
                <input type="text" id="input-code" class="input-code" maxlength="6" placeholder="C√ìDIGO">
                <br><button id="btn-connect" class="cyber-btn" onclick="connectToHost()">CONECTAR</button>
                <p id="client-status" class="match-log"></p>
            </div>
            <div id="lobby-quick-ui" class="hidden">
                <p style="color:#00ff88;">BUSCANDO SINAL...</p>
                <div class="loader"></div>
                <p id="quick-log" class="match-log">...</p>
            </div>
            <br><button class="cyber-btn secondary" onclick="location.reload()">CANCELAR</button>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div class="hud-top pointer-events-auto">
            <div style="font-size:0.8rem; background:rgba(0,0,0,0.5); display:inline-block; padding:5px 10px; margin-top:10px; cursor:pointer;" onclick="copyCode()">CANAL: <span id="room-code" style="color:#fff;">---</span></div>
            <div id="hint-pill">Sua Vez</div>
            <div class="scores">
                <div id="p1-score" class="player-score" onclick="showPlayerStats('X')">
                    <div class="score-val" style="color:var(--x-color)">0</div>
                    <div class="player-name" id="name-x">P1</div>
                </div>
                <div style="font-size:1.5rem; color:#444;">//</div>
                <div id="p2-score" class="player-score" onclick="showPlayerStats('O')">
                    <div class="score-val" style="color:var(--o-color)">0</div>
                    <div class="player-name" id="name-o">P2</div>
                </div>
            </div>
            <div class="timer-container"><div id="timer-bar" class="timer-bar"></div></div>
        </div>
        <div id="toast-msg">TOAST</div>
        <div class="hand-wrapper"><div id="hand-container" class="hand-container pointer-events-auto"></div></div>
        <button onclick="quitGame()" class="cyber-btn secondary pointer-events-auto" style="position:absolute; top:10px; right:10px; min-width:auto; padding:5px 15px; font-size:0.7rem;">ABORTAR</button>
    </div>

    <div id="screen-gameover" class="screen hidden">
        <div class="cyber-panel">
            <h1 id="winner-text" class="title-glitch">VENCEDOR</h1>
            <button class="cyber-btn secondary" onclick="location.reload()">VOLTAR AO MENU</button>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCSkDG6kWhKcuK0bhzJU7HazHBwHtuQ9zo",
        authDomain: "cartas-velhas-db.firebaseapp.com",
        projectId: "cartas-velhas-db",
        storageBucket: "cartas-velhas-db.firebasestorage.app",
        messagingSenderId: "146756048632",
        appId: "1:146756048632:web:efebe19fc28ef9f87c0d0d",
        measurementId: "G-H70FLB4DB4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let userStats = { wins: 0, losses: 0, rank: 1000, displayName: "Agente", hasSetNick: false };
    let opponentStats = { rank: '?', wins: '?' };

    // --- CONFIG E DADOS ---
    const APP_ID = "cv-tactics-final-v6-"; 
    const MAX_PUB_ROOMS = 20;
    const BOT_TIMEOUT = 10000; 

    const CARDS = {
        'PLACE': { name: 'B√°sica', icon: '‚ôüÔ∏è', rarity: 'common', weight: 40, desc: 'Coloca uma pe√ßa. 3 m√°x.' },
        'BOMB': { name: 'Bomba', icon: 'üí£', rarity: 'rare', weight: 15, desc: 'Destr√≥i pe√ßa sem escudo.' },
        'SHIELD': { name: 'Escudo', icon: 'üõ°Ô∏è', rarity: 'rare', weight: 15, desc: 'Protege contra efeitos.' },
        'MOVE': { name: 'Mover', icon: 'üîÑ', rarity: 'rare', weight: 10, desc: 'Move sua pe√ßa.' },
        'PUSH': { name: 'Empurrar', icon: '‚úã', rarity: 'rare', weight: 10, desc: 'Move pe√ßa inimiga.' },
        'SWAP': { name: 'Trocar', icon: 'üîÅ', rarity: 'legendary', weight: 10, desc: 'Troca de lugar.' }
    };

    const GameState = { board: Array(9).fill(null), history: { 'X': [], 'O': [] }, hands: { 'X': [], 'O': [] }, shields: {}, scores: { 'X': 0, 'O': 0 }, names: { 'X': 'P1', 'O': 'P2' }, turn: 'X', winner: null, targetWins: 3, winningLine: null };
    let peer, conn, mySide = null, isHost = false, isBotMatch = false;
    let timeLeft = 16, myName = "Agente", isQuickMatch = false;
    let selectedHandIdx = null, activeCardType = null, stepSourceIdx = null;
    let particles = [], cameraShake = 0;
    let isInGame = false;

    // --- DB LOGIC ---
    async function loadUserProfile(user) {
        try {
            const doc = await db.collection('players').doc(user.uid).get();
            if (doc.exists) {
                userStats = doc.data();
                if(userStats.hasSetNick) {
                    myName = userStats.displayName;
                    openScreen('screen-menu'); // Vai direto para o menu
                    showToast(`BEM-VINDO ${myName}`, "#00ff88");
                } else {
                    openScreen('screen-nickname'); // Vai para cadastro de nick
                }
            } else {
                userStats = { displayName: "Agente", photoURL: user.photoURL, wins: 0, losses: 0, rank: 1000, hasSetNick: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                await db.collection('players').doc(user.uid).set(userStats);
                openScreen('screen-nickname');
            }
            updateUIWithStats();
        } catch (e) { console.error(e); showToast("ERRO DB", "#ff0000"); }
    }

    function saveInitialNickname() {
        if(!currentUser) return;
        const newNick = document.getElementById('initial-nick-input').value.trim();
        if(newNick.length > 2 && newNick.length <= 10) {
            db.collection('players').doc(currentUser.uid).update({ displayName: newNick, hasSetNick: true }).then(() => {
                userStats.displayName = newNick; userStats.hasSetNick = true; myName = newNick;
                updateUIWithStats();
                openScreen('screen-menu');
            }).catch(e => showToast("ERRO", "#ff0000"));
        } else showToast("INV√ÅLIDO (3-10)", "#ff3333");
    }

    function saveNewNickname() {
        if(!currentUser) return;
        const newNick = document.getElementById('edit-nick-input').value.trim();
        if(newNick.length > 2 && newNick.length <= 10) {
            db.collection('players').doc(currentUser.uid).update({ displayName: newNick }).then(() => {
                userStats.displayName = newNick; myName = newNick; // Atualiza localmente
                updateUIWithStats();
                showToast("NOME ATUALIZADO", "#00ff88");
            }).catch(e => showToast("ERRO", "#ff0000"));
        } else showToast("INV√ÅLIDO", "#ff3333");
    }

    function updateUIWithStats() {
        // Menu HUD
        document.getElementById('menu-avatar').src = currentUser ? currentUser.photoURL : '';
        document.getElementById('menu-nick').innerText = userStats.displayName || "Agente";
        document.getElementById('menu-status').innerText = `ELO: ${userStats.rank}`;
        
        // Perfil Modal
        document.getElementById('detail-profile-img').src = currentUser ? currentUser.photoURL : '';
        document.getElementById('edit-nick-input').value = userStats.displayName || "";
        document.getElementById('stat-rank').innerText = userStats.rank;
        document.getElementById('stat-wins').innerText = userStats.wins;
        document.getElementById('stat-losses').innerText = userStats.losses;
    }

    async function searchPlayer() {
        const query = document.getElementById('search-player-input').value.trim();
        const area = document.getElementById('search-results-area');
        area.innerHTML = '<div class="loader"></div>';
        try {
            const snap = await db.collection('players').where('displayName', '==', query).limit(5).get();
            area.innerHTML = '';
            if(snap.empty) { area.innerHTML = '<p style="color:#aaa; text-align:center;">NADA ENCONTRADO</p>'; return; }
            snap.forEach(doc => {
                const p = doc.data();
                area.innerHTML += `<div style="background:rgba(0,0,0,0.5); padding:10px; margin-bottom:5px; border-left:2px solid var(--o-color); display:flex; align-items:center; gap:10px;">
                    <img src="${p.photoURL}" style="width:30px; height:30px; border-radius:50%;">
                    <div><div style="font-weight:bold;">${p.displayName}</div><div style="font-size:0.7rem; color:#bd00ff;">Rank: ${p.rank}</div></div>
                </div>`;
            });
        } catch(e) { console.error(e); area.innerHTML = 'ERRO'; }
    }

    async function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '<div class="loader"></div>';
        try {
            const snap = await db.collection('players').orderBy('rank', 'desc').limit(100).get();
            list.innerHTML = '';
            let i = 1;
            snap.forEach(doc => {
                const p = doc.data();
                const hl = (currentUser && doc.id === currentUser.uid) ? 'background:rgba(0,229,255,0.1);' : '';
                list.innerHTML += `<div class="ranking-row" style="${hl}"><span style="width:30px;color:var(--o-color);">${i++}</span><span style="flex:1;">${p.displayName}</span><span style="color:#bd00ff;">${p.rank}</span></div>`;
            });
        } catch(e) { list.innerHTML = 'ERRO CARREGAR'; }
    }

    // --- AUTH ---
    function loginGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => console.error(e)); }
    function logout() { auth.signOut().then(() => location.reload()); }
    
    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            loadUserProfile(user);
        } else {
            currentUser = null;
            openScreen('screen-login');
        }
    });

    // --- UI HELPERS ---
    function openScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'screen-leaderboard') loadLeaderboard();
        if(id === 'screen-cards') renderCardsHelp();
    }
    function renderCardsHelp() {
        const c = document.getElementById('cards-list-ui'); c.innerHTML='';
        for(let k in CARDS) c.innerHTML+=`<div class="card-row"><div class="card-preview">${CARDS[k].icon}</div><div class="card-info"><div class="card-title">${CARDS[k].name} <span class="card-rarity rarity-${CARDS[k].rarity}">${CARDS[k].rarity}</span></div><div class="card-desc-text">${CARDS[k].desc}</div></div></div>`;
    }
    function resetLobbyUI() { ['lobby-host-ui','lobby-client-ui','lobby-quick-ui'].forEach(id => document.getElementById(id).classList.add('hidden')); }

    // --- THREE.JS ---
    const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x050510, 0.02);
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 100);
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('canvas-container').appendChild(renderer.domElement);
    const pieceGroup = new THREE.Group(); scene.add(pieceGroup);
    const particlesGroup = new THREE.Group(); scene.add(particlesGroup);
    const grid = new THREE.GridHelper(100, 100, 0x111111, 0x0a0a0a); grid.position.y = -2; scene.add(grid);
    const tiles=[]; const tileGeo=new THREE.BoxGeometry(2.8,0.2,2.8);
    for(let i=0;i<9;i++){ const t=new THREE.Mesh(tileGeo,new THREE.MeshStandardMaterial({color:0x111116})); t.position.set((i%3-1)*3.1,0,(Math.floor(i/3)-1)*3.1); t.userData={id:i}; t.add(new THREE.LineSegments(new THREE.EdgesGeometry(tileGeo),new THREE.LineBasicMaterial({color:0x333344,transparent:true,opacity:0.3}))); scene.add(t); tiles.push(t); }
    const lights=[new THREE.DirectionalLight(0xffffff,0.5), new THREE.PointLight(0xff0055,1,30), new THREE.PointLight(0x00e5ff,1,30)];
    lights[0].position.set(5,10,5); lights[1].position.set(5,5,5); lights[2].position.set(-5,5,-5);
    lights.forEach(l=>scene.add(l)); scene.add(new THREE.AmbientLight(0xffffff,0.3));

    const particleGeo = new THREE.BoxGeometry(0.1, 0.1, 0.1); 
    function spawnWinParticles(idxList) {
        idxList.forEach(idx => {
            const x = (idx%3-1)*3.1; const z = (Math.floor(idx/3)-1)*3.1;
            const color = GameState.board[idx] === 'X' ? 0xff0055 : 0x00e5ff;
            for(let i=0; i<15; i++) particles.push({ pos: new THREE.Vector3(x + (Math.random()-0.5), 2, z + (Math.random()-0.5)), vel: new THREE.Vector3(0, Math.random()*0.2, 0), life: 2.0, color: color, gravity: -0.05 });
        });
    }

    function updateVisuals() {
        camera.userData.targetRot = (mySide==='X') ? 0 : Math.PI; pieceGroup.clear();
        if(GameState.winningLine) spawnWinParticles(GameState.winningLine);
        GameState.board.forEach((c, i) => {
            if(c) {
                const x = (i%3-1)*3.1; const z = (Math.floor(i/3)-1)*3.1;
                const isWinner = GameState.winningLine && GameState.winningLine.includes(i);
                let m;
                if(c==='X') { const g=new THREE.Group(), mat=new THREE.MeshStandardMaterial({color:0xff0055,emissive:0xff0055,emissiveIntensity:isWin?5:1}); g.add(new THREE.Mesh(new THREE.BoxGeometry(2,0.4,0.4),mat)).rotation.y=Math.PI/4; g.children[0].add(new THREE.Mesh(new THREE.BoxGeometry(2,0.4,0.4),mat)).rotation.y=-Math.PI/2; m=g; }
                else { m=new THREE.Mesh(new THREE.TorusGeometry(0.8,0.2,16,32),new THREE.MeshStandardMaterial({color:0x00e5ff,emissive:0x00e5ff,emissiveIntensity:isWin?5:1})); m.rotation.x=Math.PI/2; }
                m.position.set(x,1,z); if(isWin) m.userData.spin=0.2;
                if(GameState.history[c][0]===i && GameState.history[c].length===3 && !isWin) m.userData.glitch=true;
                if(GameState.shields[i]) m.add(new THREE.Mesh(new THREE.IcosahedronGeometry(1.2),new THREE.MeshBasicMaterial({color:0x0088ff,wireframe:true})));
                pieceGroup.add(m);
            }
        });
        document.getElementById('p1-score').innerHTML=`<div class="score-val" style="color:var(--x-color)">${GameState.scores.X}</div><div class="player-name">${GameState.names.X}</div>`;
        document.getElementById('p2-score').innerHTML=`<div class="score-val" style="color:var(--o-color)">${GameState.scores.O}</div><div class="player-name">${GameState.names.O}</div>`;
        updateHandUI();
    }

    function animate() {
        requestAnimationFrame(animate);
        const tr = isInGame ? (camera.userData.targetRot||0) : 0; 
        if(isInGame) {
            camera.position.x = Math.sin(THREE.MathUtils.lerp(Math.asin(camera.position.x/14)||0, tr, 0.05))*14;
            camera.position.z = Math.cos(THREE.MathUtils.lerp(Math.acos(camera.position.z/14)||0, tr, 0.05))*14;
            camera.position.y = 15; camera.lookAt(0,0,0);
        } else {
            camera.position.x = Math.sin(Date.now()*.0005)*18; camera.position.z = Math.cos(Date.now()*.0005)*18; camera.position.y=12; camera.lookAt(0,0,0);
        }
        pieceGroup.children.forEach(p=>{ if(p.userData.spin) p.rotation.y+=p.userData.spin; if(p.userData.glitch) p.visible=Math.random()>0.2; });
        particlesGroup.clear();
        for(let i=particles.length-1; i>=0; i--) { const p=particles[i]; p.life-=0.02; p.pos.add(p.vel); if(p.gravity) p.vel.y+=p.gravity; if(p.life<=0) { particles.splice(i,1); continue; } 
            const m=new THREE.Mesh(particleGeo, new THREE.MeshBasicMaterial({color:p.color})); m.position.copy(p.pos); particlesGroup.add(m); 
        }
        renderer.render(scene, camera);
    }
    animate();
    window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

    // --- LOGICA JOGO (Mantida) ---
    function initPeer(id) { return new Peer(id, { debug: 1 }); }
    function openLobby(mode) { openScreen('screen-lobby-wait'); resetLobbyUI(); if (mode === 'host') setupHost(); else document.getElementById('lobby-client-ui').classList.remove('hidden'); }
    function setupHost() { isHost=true; mySide='X'; isBotMatch=false; resetLobbyUI(); document.getElementById('lobby-host-ui').classList.remove('hidden'); const code=Math.random().toString(36).substr(2, 6).toUpperCase(); document.getElementById('display-code').innerText=code; GameState.names['X']=myName; peer=initPeer(APP_ID+code); peer.on('connection', handleConn); }
    function connectToHost() { const code=document.getElementById('input-code').value.trim().toUpperCase(); if(code.length<4)return; isHost=false; mySide='O'; isBotMatch=false; document.getElementById('btn-connect').innerText="..."; peer=initPeer(); peer.on('open', ()=>{ conn=peer.connect(APP_ID+code); handleConn(); }); }
    function handleConn(c) { if(c) conn=c; conn.on('open', ()=>{ conn.send({type:'JOIN', name:myName, rank:userStats.rank}); if(isHost&&GameState.hands.X.length===0) startGame(); }); conn.on('data', handleData); }
    function startQuickMatch() { openScreen('screen-lobby-wait'); resetLobbyUI(); document.getElementById('lobby-quick-ui').classList.remove('hidden'); findPub(0); }
    function findPub(i) { if(i>=MAX_PUB_ROOMS) { setupHost(); return; } const p=initPeer(APP_ID+'PUB-'+i); p.on('error', ()=>connectPub(i)); p.on('open', ()=>{ isHost=true; mySide='X'; GameState.names.X=myName; peer=p; peer.on('connection', handleConn); }); }
    function connectPub(i) { const p=initPeer(); p.on('open', ()=>{ conn=p.connect(APP_ID+'PUB-'+i); handleConn(); setTimeout(()=>{ if(!conn.open) findPub(i+1); }, 2000); }); }
    function startBotMatch() { isBotMatch=true; isHost=true; mySide='X'; GameState.names.X=myName; GameState.names.O="BOT"; startGame(); }
    
    function startGame() { GameState.board.fill(null); GameState.history={X:[],O:[]}; GameState.hands={X:genHand(),O:genHand()}; GameState.scores={X:0,O:0}; GameState.turn='X'; GameState.winner=null; broadcast(); }
    function genHand() { const h=['PLACE']; for(let i=0; i<2; i++) h.push(rndCard()); return h; }
    function rndCard() { const r=Math.random()*100; let s=0; for (const [k, d] of Object.entries(CARDS)) { s += d.weight; if (r <= s) return k; } return 'PLACE'; }
    
    function handleData(d) {
        if(d.type==='UPDATE') { Object.assign(GameState, d.state); if(d.hostRank) opponentStats.rank=d.hostRank; timeLeft=d.time; updateVisuals(); if(GameState.winner) gameOver(); else { isInGame=true; openScreen('ui-layer'); } }
        else if(d.type==='JOIN') { GameState.names[isHost?'O':'X']=d.name; opponentStats.rank=d.rank; if(isHost) broadcast(); }
        else if(d.type==='ACTION' && isHost) processAction(d.act, 'O');
    }
    function broadcast() { if(!isBotMatch && conn && conn.open) conn.send({type:'UPDATE', state:GameState, time:timeLeft, hostRank:userStats.rank}); updateVisuals(); if(GameState.winner) gameOver(); else { isInGame=true; openScreen('ui-layer'); } }
    
    function processAction(act, p) {
        if(GameState.turn!==p || GameState.winner) return;
        let ok=false; const {type,t,s,cIdx}=act;
        if(type==='PLACE' && !GameState.board[t]) { if(GameState.history[p].length>=3) GameState.board[GameState.history[p].shift()]=null; GameState.board[t]=p; GameState.history[p].push(t); ok=true; }
        else if(type==='BOMB' && GameState.board[t] && !GameState.shields[t]) { const v=GameState.board[t]; GameState.board[t]=null; GameState.history[v]=GameState.history[v].filter(x=>x!==t); ok=true; }
        else if(type==='SHIELD' && GameState.board[t]===p) { GameState.shields[t]=2; ok=true; }
        else if(type==='TIMEOUT') { GameState.hands[p].shift(); GameState.hands[p].push('PLACE'); ok=true; }
        // Simple Move/Push/Swap logic
        if(type==='MOVE' && GameState.board[s]===p && !GameState.board[t]) { GameState.board[s]=null; GameState.board[t]=p; GameState.history[p]=GameState.history[p].filter(x=>x!==s); GameState.history[p].push(t); ok=true; }
        if(type==='PUSH' && GameState.board[s]!==p && GameState.board[s] && !GameState.shields[s] && !GameState.board[t]) { const en=GameState.board[s]; GameState.board[s]=null; GameState.board[t]=en; GameState.history[en]=GameState.history[en].filter(x=>x!==s); GameState.history[en].push(t); ok=true; }
        if(type==='SWAP' && GameState.board[s]===p && GameState.board[t]!==p && GameState.board[t] && !GameState.shields[t]) { const en=GameState.board[t]; GameState.board[s]=en; GameState.board[t]=p; GameState.history[p]=GameState.history[p].map(x=>x===s?t:x); GameState.history[en]=GameState.history[en].map(x=>x===t?s:x); ok=true; }

        if(ok) {
            if(type!=='TIMEOUT') { GameState.hands[p].splice(cIdx,1); GameState.hands[p].push(rndCard()); }
            const win = checkWin();
            if(win) { GameState.winner=win; GameState.scores[win]++; if(GameState.scores[win]>=3) setTimeout(()=>{ GameState.winner=win; broadcast(); },2000); else setTimeout(startGame, 2500); }
            else { GameState.turn = p==='X'?'O':'X'; for(let k in GameState.shields)if(GameState.shields[k]>0)GameState.shields[k]--; timeLeft=16; }
            broadcast(); if(isBotMatch && GameState.turn==='O') setTimeout(botTurn, 1000);
        }
    }
    function checkWin() { const w=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; for(let c of w) if(GameState.board[c[0]] && GameState.board[c[0]]===GameState.board[c[1]] && GameState.board[c[0]]===GameState.board[c[2]]) { GameState.winningLine=c; return GameState.board[c[0]]; } return null; }
    
    function botTurn() {
        const e=GameState.board.map((v,i)=>v===null?i:-1).filter(i=>i!==-1);
        if(e.length) processAction({type:'PLACE', t:e[Math.floor(Math.random()*e.length)], cIdx:0}, 'O'); else processAction({type:'TIMEOUT'}, 'O');
    }

    function gameOver() { isInGame=false; openScreen('screen-gameover'); if(currentUser && GameState.winner===mySide) saveGameResult(true); else if(currentUser && GameState.winner!==mySide) saveGameResult(false); }
    function saveGameResult(w) { if(isBotMatch) return; const r=db.collection('players').doc(currentUser.uid); if(w) { r.update({wins:firebase.firestore.FieldValue.increment(1), rank:firebase.firestore.FieldValue.increment(25)}); userStats.wins++; userStats.rank+=25; } else { r.update({losses:firebase.firestore.FieldValue.increment(1), rank:firebase.firestore.FieldValue.increment(-15)}); userStats.losses++; userStats.rank-=15; } updateUIWithStats(); }

    // Input
    const ray=new THREE.Raycaster(); const mouse=new THREE.Vector2();
    window.onmousedown = e => { if(e.button===0) onInput(e.clientX, e.clientY); else resetSelection(); };
    function onInput(x,y) {
        if(!isInGame || GameState.turn!==mySide) return;
        mouse.x=(x/window.innerWidth)*2-1; mouse.y=-(y/window.innerHeight)*2+1; ray.setFromCamera(mouse, camera);
        const ints=ray.intersectObjects(tiles);
        if(ints.length && activeCardType) {
            const id=ints[0].object.userData.id;
            if(['PLACE','BOMB','SHIELD'].includes(activeCardType)) sendAct({type:activeCardType, t:id, cIdx:selectedHandIdx});
            else { if(stepSourceIdx===null) { stepSourceIdx=id; document.getElementById('hint-pill').innerText="DESTINO"; document.getElementById('hint-pill').classList.add('active'); } else { sendAct({type:activeCardType, s:stepSourceIdx, t:id, cIdx:selectedHandIdx}); } }
        }
    }
    function sendAct(a) { if(isHost) processAction(a, 'X'); else conn.send({type:'ACTION', act:a}); resetSelection(); }
    function handleCardClick(i,k) { if(GameState.turn===mySide) { selectedHandIdx=i; activeCardType=k; stepSourceIdx=null; updateHandUI(); document.getElementById('hint-pill').innerText="ALVO"; document.getElementById('hint-pill').classList.add('active'); } }
    function updateHandUI() { const c=document.getElementById('hand-container'); c.innerHTML=''; GameState.hands[mySide].forEach((k,i)=>{ const d=CARDS[k]; c.innerHTML+=`<div class="card ${d.rarity} ${i===selectedHandIdx?'selected':''}" onclick="handleCardClick(${i},'${k}')"><div class="card-icon">${d.icon}</div><div class="card-name">${d.name}</div></div>`; }); }
    function resetSelection() { selectedHandIdx=null; activeCardType=null; stepSourceIdx=null; updateHandUI(); document.getElementById('hint-pill').classList.remove('active'); }

    // Utils
    const SoundFX = { 
        playTone: (f,t,d,v=0.1)=>{ if(audioCtx.state==='suspended')audioCtx.resume(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type=t; o.frequency.setValueAtTime(f,audioCtx.currentTime); g.gain.setValueAtTime(v,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); },
        hover: ()=>SoundFX.playTone(400,'sine',0.1,0.05), click: ()=>SoundFX.playTone(800,'triangle',0.1), place: ()=>SoundFX.playTone(600,'sine',0.3), explode: ()=>SoundFX.playTone(100,'sawtooth',0.4), win: ()=>SoundFX.playTone(440,'square',0.6), matchWin: ()=>[440,554,660].forEach((f,i)=>setTimeout(()=>SoundFX.playTone(f,'square',0.4),i*150))
    };
    const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    function showToast(m,c) { const t=document.getElementById('toast-msg'); t.innerText=m; t.style.textShadow=`0 0 30px ${c}`; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
    function copyCode() { navigator.clipboard.writeText(document.getElementById('display-code').innerText); showToast("COPIADO", "#fff"); }
    function quitGame() { if(conn) conn.close(); location.reload(); }
    function showPlayerStats(s) { if(s===mySide) showToast(`EU: ${userStats.rank}`, "#fff"); else showToast(isBotMatch?"BOT":`OPONENTE: ${opponentStats.rank}`, "#ffff00"); }
    setInterval(()=>{ if(isInGame && !GameState.winner){ if(timeLeft>0) timeLeft-=0.1; document.getElementById('timer-bar').style.width=(timeLeft/16)*100+'%'; if(isHost && timeLeft<=0) processAction({type:'TIMEOUT'}, GameState.turn); } }, 100);
</script>
</body>
</html>