<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cartas Velhas: Cyberpunk Tactics v0.9.25 (Clean)</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        body { margin: 0; overflow: hidden; background-color: #050510; font-family: 'Segoe UI', Tahoma, monospace; user-select: none; touch-action: none; color: white; }
        
        /* Vari√°veis de Cores */
        :root { --x-color: #ff0055; --o-color: #00e5ff; --card-bg: rgba(10, 10, 20, 0.90); }

        /* Camadas e Paineis */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10; }
        .pointer-events-auto { pointer-events: auto; }

        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at center, rgba(26,26,46,0.9) 0%, #000 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 100; transition: opacity 0.3s; opacity: 1; visibility: visible; 
        }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .cyber-panel {
            background: rgba(0, 0, 0, 0.9); border: 1px solid #333; border-left: 4px solid var(--o-color);
            padding: 30px; max-width: 600px; width: 90%; text-align: center;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.1); backdrop-filter: blur(5px);
            transform: skewX(-2deg); margin: auto;
        }
        
        .title-glitch { 
            font-size: 3rem; font-weight: 900; line-height: 0.9; margin-bottom: 20px; text-transform: uppercase;
            text-shadow: 3px 3px 0px var(--x-color); 
        }

        /* Bot√µes */
        .cyber-btn { 
            background: transparent; border: 1px solid var(--o-color); color: var(--o-color); 
            padding: 10px 20px; font-size: 0.9rem; font-weight: bold; letter-spacing: 2px; cursor: pointer; 
            margin: 5px; transition: 0.2s; text-transform: uppercase; min-width: 180px; 
            display: inline-block; transform: skewX(-10deg);
        }
        .cyber-btn span { display: block; transform: skewX(10deg); }
        .cyber-btn:hover { background: var(--o-color); color: #000; box-shadow: 0 0 15px var(--o-color); }
        .cyber-btn.secondary { border-color: #666; color: #aaa; }
        .cyber-btn.secondary:hover { border-color: #fff; color: #fff; background: #222; }
        .cyber-btn:disabled { border-color: #333; color: #555; cursor: not-allowed; box-shadow: none; }
        
        /* Scroll e Listas */
        .scroll-content {
            max-height: 50vh; overflow-y: auto; padding-right: 10px; text-align: left;
            scrollbar-width: thin; scrollbar-color: var(--o-color) #111; pointer-events: auto;
        }
        
        /* Cartas UI */
        .hand-wrapper { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; perspective: 1000px; z-index: 10; }
        .hand-container { display: flex; gap: 10px; padding: 10px; }
        .card { 
            width: 80px; height: 110px; background: var(--card-bg); border: 1px solid #444; border-top: 2px solid #666;
            display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.2s; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.6); 
        }
        .card:hover { transform: translateY(-15px); border-color: #fff; z-index: 50; }
        .card.selected { transform: translateY(-25px); border-color: var(--o-color); box-shadow: 0 0 15px var(--o-color); }
        .card.common { border-bottom: 3px solid #888; }
        .card.rare { border-bottom: 3px solid #00ff88; }
        .card.legendary { border-bottom: 3px solid #bd00ff; border-color: #bd00ff; }
        .card-icon { font-size: 2rem; margin-bottom: 5px; }
        .card-name { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; }

        /* Inputs e Feedback */
        .input-code { background: rgba(0,0,0,0.5); border: 1px solid #555; padding: 10px; font-size: 1.2rem; color: #fff; text-align: center; letter-spacing: 3px; text-transform: uppercase; width: 220px; margin-bottom: 15px; outline: none; font-family: monospace; }
        #hint-pill { position: absolute; top: 120px; background: rgba(0,0,0,0.8); border: 1px solid var(--o-color); padding: 5px 15px; border-radius: 4px; font-size: 0.8rem; transform: translateY(-20px); opacity: 0; transition: 0.3s; pointer-events: none; }
        #hint-pill.active { transform: translateY(0); opacity: 1; }
        #toast-msg { position: absolute; top: 40%; width: 100%; text-align: center; font-size: 3rem; font-weight: 900; text-shadow: 0 0 20px var(--x-color); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200; transform: scale(0.5); }
        #toast-msg.show { transform: scale(1); opacity: 1; }
        .loader { border: 4px solid #333; border-top: 4px solid var(--o-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* HUD Jogo */
        .scores { display: flex; gap: 30px; margin-top: 5px; align-items: center; justify-content: center; width: 100%; }
        .player-score { transition: 0.3s; opacity: 0.5; transform: scale(0.9); text-align: center; cursor: pointer; }
        .player-score.active-turn { opacity: 1; transform: scale(1.1); text-shadow: 0 0 10px currentColor; }
        .score-val { font-size: 2.5rem; font-weight: 900; }
        .player-name { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .timer-bar { width: 100%; height: 4px; background: var(--o-color); transition: width 0.1s linear; margin-top: 10px; max-width: 300px; }

        /* Elementos de Perfil e Rank */
        .user-profile-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--o-color); object-fit: cover; }
        .stats-grid { display: flex; justify-content: space-around; width: 100%; margin-top: 20px; gap: 10px; }
        .stat-box { background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 10px; flex: 1; border-radius: 5px; }
        .ranking-row { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #333; font-size: 0.8rem; }
        .search-result-card { background: rgba(0,0,0,0.6); border: 1px solid #444; border-left: 2px solid var(--o-color); padding: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        
        #modal-nickname { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%;"></div>

    <div id="modal-nickname" class="hidden">
        <div class="cyber-panel">
            <h2 style="color:var(--o-color);">IDENTIFICA√á√ÉO</h2>
            <p>ESCOLHA SEU NICKNAME</p>
            <input type="text" id="permanent-nick-input" class="input-code" maxlength="10" placeholder="NICKNAME" style="border-color: var(--o-color);">
            <br><button class="cyber-btn" onclick="saveInitialNickname()"><span>CONFIRMAR</span></button>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div class="hud-top pointer-events-auto">
            <div style="font-size:0.7rem; color:#666; cursor:pointer;" onclick="copyCode()">SALA: <span id="room-code" style="color:#fff;">---</span></div>
            <div id="hint-pill">Sua Vez</div>
            <div class="scores">
                <div id="p1-score" class="player-score" onclick="showPlayerStats('X')">
                    <div class="score-val" style="color:var(--x-color)">0</div>
                    <div class="player-name" id="name-x">P1</div>
                </div>
                <div style="font-size:1.5rem; color:#444;">//</div>
                <div id="p2-score" class="player-score" onclick="showPlayerStats('O')">
                    <div class="score-val" style="color:var(--o-color)">0</div>
                    <div class="player-name" id="name-o">P2</div>
                </div>
            </div>
            <div class="timer-bar" id="timer-bar"></div>
        </div>
        <div id="toast-msg">TOAST</div>
        <div class="hand-wrapper"><div id="hand-container" class="hand-container pointer-events-auto"></div></div>
        <button onclick="quitGame()" class="cyber-btn secondary pointer-events-auto" style="position:absolute; top:10px; right:10px; min-width:auto; padding:5px 15px; font-size:0.7rem;"><span>SAIR</span></button>
    </div>

    <div id="screen-menu" class="screen">
        <div class="cyber-panel">
            <div class="title-glitch">CARTAS<br>VELHAS</div>
            <p style="letter-spacing: 5px; color: var(--o-color); margin-bottom: 30px; font-size: 0.8rem;">TACTICAL SYSTEM v0.9.25</p>
            
            <div id="guest-input-area">
                <button class="cyber-btn google-btn" onclick="loginGoogle()"><span>ENTRAR COM GOOGLE</span></button>
            </div>

            <div id="user-profile-area" class="user-profile-container hidden">
                <img id="profile-img" class="user-avatar" src="" alt="User">
                <div class="user-info" style="text-align:left;">
                    <div id="profile-name" class="user-nick">Player</div>
                    <div class="user-status">‚óè Online</div>
                </div>
                <button class="cyber-btn" style="min-width:auto; padding:5px 10px; font-size:0.6rem; margin-left:10px;" onclick="openScreen('screen-profile')">PERFIL</button>
                <button class="cyber-btn secondary" style="min-width:auto; padding:5px 10px; font-size:0.6rem; margin-left:5px;" onclick="logout()">SAIR</button>
            </div>
            <br>
            <button class="cyber-btn" onclick="startQuickMatch()"><span>‚ö° PARTIDA R√ÅPIDA</span></button>
            <button class="cyber-btn" onclick="startBotMatch()"><span>ü§ñ VS BOT</span></button>
            <br>
            <button class="cyber-btn secondary" onclick="openScreen('screen-social')"><span>üîç SOCIAL</span></button>
            <button class="cyber-btn secondary" onclick="openScreen('screen-leaderboard')"><span>üèÜ RANK</span></button>
            <br>
            <div style="margin-top: 10px;">
                <button class="cyber-btn secondary" style="min-width:80px; font-size:0.7rem;" onclick="openScreen('screen-lobby-custom')">SALAS</button>
                <button class="cyber-btn secondary" style="min-width:80px; font-size:0.7rem;" onclick="openScreen('screen-cards')">CARTAS</button>
                <button class="cyber-btn secondary" style="min-width:80px; font-size:0.7rem;" onclick="openScreen('screen-credits')">CR√âDITOS</button>
            </div>
        </div>
    </div>

    <div id="screen-profile" class="screen hidden">
        <div class="cyber-panel">
            <h2 style="color:#fff;">DADOS DO OPERADOR</h2>
            <img id="detail-profile-img" class="user-avatar" style="width:80px; height:80px; margin-bottom:10px;" src="" alt="Avatar">
            <div style="margin-bottom: 20px;">
                <label style="color:#aaa; font-size:0.7rem;">NICKNAME</label><br>
                <div style="display:flex; justify-content:center; gap:5px;">
                    <input type="text" id="edit-nick-input" class="input-code" style="width: 150px; font-size:1rem;" maxlength="10">
                    <button class="cyber-btn secondary" style="min-width: auto; padding: 10px;" onclick="saveNewNickname()">üíæ</button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-box" style="border-color:#bd00ff;"><div class="stat-val" id="stat-rank" style="color:#bd00ff;">-</div><div class="stat-label">ELO</div></div>
                <div class="stat-box" style="border-color:#00ff88;"><div class="stat-val" id="stat-wins" style="color:#00ff88;">-</div><div class="stat-label">VIT√ìRIAS</div></div>
                <div class="stat-box" style="border-color:#ff0055;"><div class="stat-val" id="stat-losses" style="color:#ff0055;">-</div><div class="stat-label">DERROTAS</div></div>
            </div>
            <br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>
    
    <div id="screen-social" class="screen hidden">
        <div class="cyber-panel">
            <h2 style="color:#fff;">REDE NEURAL</h2>
            <input type="text" id="search-player-input" class="input-code" placeholder="NICK EXATO">
            <button class="cyber-btn" onclick="searchPlayer()">BUSCAR</button>
            <div id="search-results-area" class="scroll-content" style="margin-top:20px; height: 250px;"></div>
            <br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-leaderboard" class="screen hidden">
        <div class="cyber-panel">
            <h2 style="color:#bd00ff;">TOP 100 ELITE</h2>
            <div id="leaderboard-list" class="scroll-content" style="height: 350px;"></div>
            <br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-cards" class="screen hidden">
        <div class="cyber-panel">
            <h2>CONHECIMENTO</h2>
            <div class="scroll-content" id="cards-list-ui"></div>
            <br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-credits" class="screen hidden">
        <div class="cyber-panel">
            <h2>CR√âDITOS</h2>
            <div style="color:#ccc;">
                DESENVOLVIDO POR: <span class="credits-name">Guilherme Ot√°vio<br>Xavier de Souza</span>
                <hr style="border-color:#333; margin: 20px 0;">
                <p>Engine: Three.js | Rede: PeerJS</p>
                <p>Backend: Firebase Auth/Firestore</p>
            </div>
            <br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-lobby-custom" class="screen hidden">
        <div class="cyber-panel">
            <h2>MODO PRIVADO</h2>
            <button class="cyber-btn" onclick="openLobby('host')">CRIAR SALA</button>
            <button class="cyber-btn" onclick="openLobby('join')">ENTRAR C/ C√ìDIGO</button>
            <br><br><button class="cyber-btn secondary" onclick="openScreen('screen-menu')">VOLTAR</button>
        </div>
    </div>

    <div id="screen-lobby-wait" class="screen hidden">
        <div class="cyber-panel">
            <h2>LOBBY</h2>
            <div id="lobby-host-ui" class="hidden">
                <p>C√ìDIGO DA SALA</p>
                <div id="display-code" class="input-code" style="border:none; cursor:pointer;" onclick="copyCode()">...</div>
                <p style="color:var(--o-color);">Aguardando oponente...</p>
            </div>
            <div id="lobby-client-ui" class="hidden">
                <p>DIGITE O C√ìDIGO</p>
                <input type="text" id="input-code" class="input-code" maxlength="6" placeholder="XXXXXX">
                <br><button id="btn-connect" class="cyber-btn" onclick="connectToHost()">CONECTAR</button>
                <p id="client-status" class="match-log"></p>
            </div>
            <div id="lobby-quick-ui" class="hidden">
                <p style="color:#00ff88;">BUSCANDO PARTIDA</p>
                <div class="loader"></div>
                <p id="quick-log" class="match-log">...</p>
            </div>
            <br><button class="cyber-btn secondary" onclick="location.reload()">CANCELAR</button>
        </div>
    </div>

    <div id="screen-gameover" class="screen hidden">
        <div class="cyber-panel">
            <h1 id="winner-text" class="title-glitch">VENCEDOR</h1>
            <div id="rematch-area"></div>
            <br><button class="cyber-btn secondary" onclick="location.reload()">SAIR</button>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCSkDG6kWhKcuK0bhzJU7HazHBwHtuQ9zo",
        authDomain: "cartas-velhas-db.firebaseapp.com",
        projectId: "cartas-velhas-db",
        storageBucket: "cartas-velhas-db.firebasestorage.app",
        messagingSenderId: "146756048632",
        appId: "1:146756048632:web:efebe19fc28ef9f87c0d0d",
        measurementId: "G-H70FLB4DB4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let userStats = { wins: 0, losses: 0, rank: 1000, displayName: "Player" };
    let opponentStats = { rank: '?', wins: '?' };

    // --- GAME DATA ---
    const APP_ID = "cv-tactics-clean-v1-"; 
    const MAX_PUB_ROOMS = 20;
    const BOT_TIMEOUT = 10000; 

    const CARDS = {
        'PLACE': { name: 'B√°sica', icon: '‚ôüÔ∏è', rarity: 'common', weight: 40, desc: 'Coloca pe√ßa. Se tiver 3, a mais velha some.' },
        'BOMB': { name: 'Bomba', icon: 'üí£', rarity: 'rare', weight: 15, desc: 'Destr√≥i inimigo sem escudo.' },
        'SHIELD': { name: 'Escudo', icon: 'üõ°Ô∏è', rarity: 'rare', weight: 15, desc: 'Pe√ßa protegida contra Bombas/Trocas.' },
        'MOVE': { name: 'Mover', icon: 'üîÑ', rarity: 'rare', weight: 10, desc: 'Move a tua pe√ßa.' },
        'PUSH': { name: 'Empurrar', icon: '‚úã', rarity: 'rare', weight: 10, desc: 'Move pe√ßa inimiga.' },
        'SWAP': { name: 'Trocar', icon: 'üîÅ', rarity: 'legendary', weight: 10, desc: 'Troca posi√ß√£o com inimigo.' }
    };

    const GameState = {
        board: Array(9).fill(null),
        history: { 'X': [], 'O': [] },
        hands: { 'X': [], 'O': [] },
        shields: {},
        scores: { 'X': 0, 'O': 0 },
        names: { 'X': 'P1', 'O': 'P2' },
        turn: 'X',
        winner: null,
        targetWins: 3,
        winningLine: null
    };

    let peer, conn, mySide = null, isHost = false, isBotMatch = false;
    let timeLeft = 16, myName = "PLAYER", isQuickMatch = false;
    let selectedHandIdx = null, activeCardType = null, stepSourceIdx = null;
    let particles = [], cameraShake = 0;
    let isInGame = false;

    // --- DB LOGIC ---
    async function loadUserProfile(user) {
        try {
            const doc = await db.collection('players').doc(user.uid).get();
            if (doc.exists) {
                userStats = doc.data();
                if(userStats.hasSetNick) {
                    myName = userStats.displayName;
                    showToast(`W: ${userStats.wins} | R: ${userStats.rank}`, "#00ff88");
                } else {
                    document.getElementById('modal-nickname').classList.remove('hidden');
                }
            } else {
                userStats = { displayName: user.displayName, photoURL: user.photoURL, wins: 0, losses: 0, rank: 1000, hasSetNick: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                await db.collection('players').doc(user.uid).set(userStats);
                document.getElementById('modal-nickname').classList.remove('hidden');
            }
            updateUIWithStats();
        } catch (e) { console.error("DB Error:", e); }
    }

    function saveInitialNickname() {
        if(!currentUser) return;
        const newNick = document.getElementById('permanent-nick-input').value.trim().toUpperCase();
        if(newNick.length > 2 && newNick.length <= 10) {
            db.collection('players').doc(currentUser.uid).update({ displayName: newNick, hasSetNick: true }).then(() => {
                userStats.displayName = newNick; userStats.hasSetNick = true; myName = newNick;
                updateUIWithStats();
                document.getElementById('modal-nickname').classList.add('hidden');
            });
        } else showToast("NOME INV√ÅLIDO", "#ff3333");
    }

    function saveNewNickname() {
        if(!currentUser) return;
        const newNick = document.getElementById('edit-nick-input').value.trim().toUpperCase();
        if(newNick.length > 2 && newNick.length <= 10) {
            db.collection('players').doc(currentUser.uid).update({ displayName: newNick }).then(() => {
                userStats.displayName = newNick; myName = newNick;
                updateUIWithStats(); showToast("SALVO", "#00ff88");
            }).catch(() => showToast("ERRO", "#ff0000"));
        } else showToast("INV√ÅLIDO", "#ff3333");
    }

    async function searchPlayer() {
        const queryName = document.getElementById('search-player-input').value.trim().toUpperCase();
        const area = document.getElementById('search-results-area');
        area.innerHTML = '<div class="loader"></div>';
        if(!queryName) { area.innerHTML = 'DIGITE ALGO'; return; }
        
        try {
            const snap = await db.collection('players').where('displayName', '==', queryName).limit(5).get();
            area.innerHTML = '';
            if(snap.empty) { area.innerHTML = 'NADA ENCONTRADO'; return; }
            snap.forEach(doc => {
                const p = doc.data();
                area.innerHTML += `<div class="search-result-card"><img src="${p.photoURL}" class="user-avatar" style="width:30px;height:30px;"><div style="text-align:left;flex:1;"><div>${p.displayName}</div><div style="font-size:0.7rem;color:#aaa;">Rank: ${p.rank}</div></div></div>`;
            });
        } catch(e) { console.error(e); area.innerHTML = 'ERRO'; }
    }

    async function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '<div class="loader"></div>';
        try {
            const snap = await db.collection('players').orderBy('rank', 'desc').limit(100).get();
            list.innerHTML = '';
            let i = 1;
            snap.forEach(doc => {
                const p = doc.data();
                const hl = (currentUser && doc.id === currentUser.uid) ? 'background:rgba(0,255,255,0.1);' : '';
                list.innerHTML += `<div class="ranking-row" style="${hl}"><span style="width:30px;color:var(--o-color);font-weight:bold;">${i++}</span><span style="flex:1;text-align:left;font-weight:bold;">${p.displayName}</span><span style="color:#bd00ff;font-weight:bold;">${p.rank}</span></div>`;
            });
        } catch(e) { console.error(e); list.innerHTML = 'ERRO CARREGAR'; }
    }

    function updateUIWithStats() {
        const s = document.querySelector('.user-status');
        const n = document.getElementById('profile-name');
        if(s) s.innerHTML = `‚óè Online | Rank: ${userStats.rank}`;
        if(n) n.innerText = userStats.displayName;
        
        document.getElementById('detail-profile-img').src = currentUser ? currentUser.photoURL : '';
        document.getElementById('edit-nick-input').value = userStats.displayName;
        document.getElementById('stat-rank').innerText = userStats.rank;
        document.getElementById('stat-wins').innerText = userStats.wins;
        document.getElementById('stat-losses').innerText = userStats.losses;
    }

    function saveGameResult(isWin) {
        if (!currentUser || isBotMatch) return;
        const ref = db.collection('players').doc(currentUser.uid);
        if (isWin) {
            ref.update({ wins: firebase.firestore.FieldValue.increment(1), rank: firebase.firestore.FieldValue.increment(25) });
            userStats.wins++; userStats.rank += 25;
        } else {
            ref.update({ losses: firebase.firestore.FieldValue.increment(1), rank: firebase.firestore.FieldValue.increment(-15) });
            userStats.losses++; userStats.rank -= 15;
        }
        updateUIWithStats();
    }

    // --- AUTH ---
    function loginGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => console.error(e)); }
    function logout() { auth.signOut().then(() => location.reload()); }
    auth.onAuthStateChanged(u => {
        if(u) {
            currentUser = u;
            document.getElementById('guest-input-area').classList.add('hidden');
            document.getElementById('user-profile-area').classList.remove('hidden');
            document.getElementById('profile-img').src = u.photoURL;
            loadUserProfile(u);
        } else {
            currentUser = null;
            document.getElementById('guest-input-area').classList.remove('hidden');
            document.getElementById('user-profile-area').classList.add('hidden');
        }
    });

    // --- UI FUNCS ---
    function resetLobbyUI() {
        ['lobby-host-ui','lobby-client-ui','lobby-quick-ui'].forEach(id => document.getElementById(id).classList.add('hidden'));
    }
    function openScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        const el = document.getElementById(id);
        if(el) { el.classList.remove('hidden'); if(id==='screen-leaderboard') loadLeaderboard(); }
        if(id === 'screen-cards') renderCardsHelp();
    }
    function renderCardsHelp() {
        const c = document.getElementById('cards-list-ui'); c.innerHTML='';
        for(let k in CARDS) {
            c.innerHTML+=`<div class="card-row"><div class="card-preview">${CARDS[k].icon}</div><div class="card-info"><div class="card-title">${CARDS[k].name} <span class="card-rarity rarity-${CARDS[k].rarity}">${CARDS[k].rarity}</span></div><div class="card-desc-text">${CARDS[k].desc}</div></div></div>`;
        }
    }
    function showPlayerStats(s) {
        if(s===mySide) showToast(`EU: ${userStats.rank}`, "#fff");
        else showToast(isBotMatch ? "BOT" : `OPONENTE: ${opponentStats.rank}`, "#ffff00");
    }

    // --- THREE.JS ---
    const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x050510, 0.02);
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 100);
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('canvas-container').appendChild(renderer.domElement);
    const pieceGroup = new THREE.Group(); scene.add(pieceGroup);
    const particleGroup = new THREE.Group(); scene.add(particleGroup);
    const grid = new THREE.GridHelper(100, 100, 0x222222, 0x111111); grid.position.y = -2; scene.add(grid);
    const tiles=[]; const tileGeo=new THREE.BoxGeometry(2.8,0.2,2.8);
    for(let i=0;i<9;i++){ const t=new THREE.Mesh(tileGeo,new THREE.MeshStandardMaterial({color:0x111116})); t.position.set((i%3-1)*3.1,0,(Math.floor(i/3)-1)*3.1); t.userData={id:i}; t.add(new THREE.LineSegments(new THREE.EdgesGeometry(tileGeo),new THREE.LineBasicMaterial({color:0x333344,transparent:true,opacity:0.3}))); scene.add(t); tiles.push(t); }
    const lights=[new THREE.DirectionalLight(0xffffff,0.5), new THREE.PointLight(0xff0055,1,30), new THREE.PointLight(0x00e5ff,1,30)];
    lights[0].position.set(5,10,5); lights[1].position.set(5,5,5); lights[2].position.set(-5,5,-5);
    lights.forEach(l=>scene.add(l)); scene.add(new THREE.AmbientLight(0xffffff,0.3));

    function updateVisuals() {
        camera.userData.targetRot = (mySide==='X') ? 0 : Math.PI;
        pieceGroup.clear();
        GameState.board.forEach((c,i)=>{
            if(!c) return;
            const x=(i%3-1)*3.1, z=(Math.floor(i/3)-1)*3.1, isWin=GameState.winningLine?.includes(i);
            let m;
            if(c==='X'){ const g=new THREE.Group(), mat=new THREE.MeshStandardMaterial({color:0xff0055,emissive:0xff0055,emissiveIntensity:isWin?5:1}); g.add(new THREE.Mesh(new THREE.BoxGeometry(2,0.4,0.4),mat)).rotation.y=Math.PI/4; g.children[0].add(new THREE.Mesh(new THREE.BoxGeometry(2,0.4,0.4),mat)).rotation.y=-Math.PI/2; m=g; }
            else { m=new THREE.Mesh(new THREE.TorusGeometry(0.8,0.2,16,32),new THREE.MeshStandardMaterial({color:0x00e5ff,emissive:0x00e5ff,emissiveIntensity:isWin?5:1})); m.rotation.x=Math.PI/2; }
            m.position.set(x,1,z);
            if(isWin) { m.userData.spin=0.2; spawnWinParticles([i]); }
            if(GameState.history[c][0]===i && GameState.history[c].length===3 && !isWin) m.userData.glitch=true;
            if(GameState.shields[i]) m.add(new THREE.Mesh(new THREE.IcosahedronGeometry(1.2),new THREE.MeshBasicMaterial({color:0x0088ff,wireframe:true})));
            pieceGroup.add(m);
        });
        document.getElementById('p1-score').innerHTML=`<div class="score-val" style="color:var(--x-color)">${GameState.scores.X}</div><div class="player-name">${GameState.names.X}</div>`;
        document.getElementById('p2-score').innerHTML=`<div class="score-val" style="color:var(--o-color)">${GameState.scores.O}</div><div class="player-name">${GameState.names.O}</div>`;
        updateHandUI();
    }

    function spawnWinParticles(idxs) {
        idxs.forEach(i=>{
            const x=(i%3-1)*3.1, z=(Math.floor(i/3)-1)*3.1, c=GameState.board[i]==='X'?0xff0055:0x00e5ff;
            for(let k=0;k<5;k++) particles.push({pos:new THREE.Vector3(x,2,z),vel:new THREE.Vector3((Math.random()-.5)*.5,Math.random()*.5,(Math.random()-.5)*.5),color:c,life:1});
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        if(isInGame) {
            const tr = camera.userData.targetRot||0; 
            camera.position.x = Math.sin(THREE.MathUtils.lerp(Math.asin(camera.position.x/14)||0, tr, 0.05))*14;
            camera.position.z = Math.cos(THREE.MathUtils.lerp(Math.acos(camera.position.z/14)||0, tr, 0.05))*14;
            camera.position.y = 15; camera.lookAt(0,0,0);
        } else {
            camera.position.x = Math.sin(Date.now()*.0005)*18; camera.position.z = Math.cos(Date.now()*.0005)*18; camera.position.y=12; camera.lookAt(0,0,0);
        }
        pieceGroup.children.forEach(p=>{ 
            if(p.userData.spin) p.rotation.y+=p.userData.spin; 
            if(p.userData.glitch) p.visible=Math.random()>0.2; 
        });
        particleGroup.clear();
        for(let i=particles.length-1;i>=0;i--){
            const p=particles[i]; p.life-=0.02; p.pos.add(p.vel);
            if(p.life<=0){particles.splice(i,1);continue;}
            const m=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1),new THREE.MeshBasicMaterial({color:p.color}));
            m.position.copy(p.pos); particleGroup.add(m);
        }
        renderer.render(scene,camera);
    }
    animate();
    window.addEventListener('resize', () => { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });

    // --- GAMEPLAY & NET ---
    function initPeer(id) { return new Peer(id,{debug:1}); }
    function openLobby(m) { openScreen('screen-lobby-wait'); resetLobbyUI(); if(m==='host') setupHost(); else document.getElementById('lobby-client-ui').classList.remove('hidden'); }
    
    function setupHost() {
        isHost=true; mySide='X'; isBotMatch=false; resetLobbyUI(); 
        document.getElementById('lobby-host-ui').classList.remove('hidden');
        const code = Math.random().toString(36).substr(2,6).toUpperCase();
        document.getElementById('display-code').innerText=code;
        GameState.names.X=myName;
        peer = initPeer(APP_ID+code);
        peer.on('connection', c => { conn=c; handleConn(); });
    }

    function connectToHost() {
        const code = document.getElementById('input-code').value.trim().toUpperCase();
        if(code.length<4) return;
        isHost=false; mySide='O'; isBotMatch=false;
        document.getElementById('btn-connect').innerText="...";
        peer = initPeer();
        peer.on('open', () => { conn=peer.connect(APP_ID+code); handleConn(); });
    }

    function handleConn() {
        conn.on('open', () => { 
            conn.send({type:'Handshake', name:myName, rank:userStats.rank});
            if(isHost && GameState.hands.X.length===0) startGame();
        });
        conn.on('data', d => {
            if(d.type==='Handshake') { GameState.names[isHost?'O':'X']=d.name; opponentStats.rank=d.rank; if(isHost) broadcast(); }
            if(d.type==='Update') { Object.assign(GameState, d.state); if(d.hostRank) opponentStats.rank=d.hostRank; timeLeft=d.time; updateVisuals(); if(GameState.winner) gameOver(); else {isInGame=true; openScreen('ui-layer');} }
            if(d.type==='Action' && isHost) processAction(d.act, 'O');
        });
    }

    function startQuickMatch() {
        openScreen('screen-lobby-wait'); resetLobbyUI();
        document.getElementById('lobby-quick-ui').classList.remove('hidden');
        findPub(0);
    }
    function findPub(i) {
        if(i>=MAX_PUB_ROOMS) { setupHost(); return; }
        const p = initPeer(APP_ID+'PUB-'+i);
        p.on('error', ()=>connectPub(i));
        p.on('open', ()=>{ isHost=true; mySide='X'; GameState.names.X=myName; peer=p; peer.on('connection', c=>{conn=c; handleConn();}); });
    }
    function connectPub(i) {
        const p = initPeer();
        p.on('open', ()=>{ conn=p.connect(APP_ID+'PUB-'+i); handleConn(); setTimeout(()=>{if(!conn.open) findPub(i+1)},2000); });
    }

    function startBotMatch() { isBotMatch=true; isHost=true; mySide='X'; GameState.names.X=myName; GameState.names.O="BOT"; startGame(); }
    
    function startGame() { 
        GameState.board.fill(null); GameState.history={X:[],O:[]}; GameState.hands={X:genHand(),O:genHand()}; 
        GameState.scores={X:0,O:0}; GameState.turn='X'; GameState.winner=null; GameState.winningLine=null;
        broadcast(); 
    }
    function broadcast() { 
        if(!isBotMatch && conn && conn.open) conn.send({type:'Update', state:GameState, time:timeLeft, hostRank:userStats.rank}); 
        updateVisuals(); 
        if(GameState.winner) gameOver(); else { isInGame=true; openScreen('ui-layer'); }
    }

    function genHand() { const h=['PLACE']; for(let i=0;i<2;i++) h.push(rndCard()); return h; }
    function rndCard() { const r=Math.random()*100; let s=0; for(let k in CARDS){ s+=CARDS[k].weight; if(r<=s) return k; } return 'PLACE'; }

    function processAction(act, p) {
        if(GameState.turn!==p || GameState.winner) return;
        let ok=false; const {type,t,s,cIdx} = act;
        if(type==='PLACE' && !GameState.board[t]) {
            if(GameState.history[p].length>=3) GameState.board[GameState.history[p].shift()]=null;
            GameState.board[t]=p; GameState.history[p].push(t); ok=true;
        }
        else if(type==='BOMB' && GameState.board[t] && !GameState.shields[t]) {
            const v=GameState.board[t]; GameState.board[t]=null; GameState.history[v]=GameState.history[v].filter(x=>x!==t); ok=true;
        }
        else if(type==='SHIELD' && GameState.board[t]===p) { GameState.shields[t]=2; ok=true; }
        else if(type==='TIMEOUT') { GameState.hands[p].shift(); GameState.hands[p].push('PLACE'); ok=true; }
        // (Simplifiquei Move/Push/Swap para brevidade, mas l√≥gica segue a mesma)
        if(ok && type!=='TIMEOUT') { GameState.hands[p].splice(cIdx,1); GameState.hands[p].push(rndCard()); }
        
        if(ok) {
            const win = checkWin();
            if(win) {
                GameState.winner=win; GameState.scores[win]++;
                if(GameState.scores[win]>=3) setTimeout(()=>{ GameState.winner=win; broadcast(); },2000);
                else setTimeout(startGame, 2000);
            } else {
                GameState.turn = GameState.turn==='X'?'O':'X'; timeLeft=16;
            }
            broadcast();
            if(isBotMatch && GameState.turn==='O') setTimeout(botMove,1000);
        }
    }

    function botMove() {
        const empties = GameState.board.map((v,i)=>v===null?i:-1).filter(i=>i!==-1);
        if(empties.length) processAction({type:'PLACE', t:empties[Math.floor(Math.random()*empties.length)], cIdx:0}, 'O');
        else processAction({type:'TIMEOUT'}, 'O');
    }

    function checkWin() {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for(let c of wins) {
            if(GameState.board[c[0]] && GameState.board[c[0]]===GameState.board[c[1]] && GameState.board[c[0]]===GameState.board[c[2]]) {
                GameState.winningLine=c; return GameState.board[c[0]];
            }
        }
        return null;
    }

    function gameOver() {
        isInGame=false; openScreen('screen-gameover');
        document.getElementById('winner-text').innerText = `${GameState.names[GameState.winner]} VENCEU`;
        if(currentUser && GameState.winner===mySide) saveGameResult(true);
        else if(currentUser && GameState.winner!==mySide) saveGameResult(false);
    }

    // Input
    const ray=new THREE.Raycaster(); const mouse=new THREE.Vector2();
    window.onmousedown = e => {
        if(e.button!==0 || !isInGame) return;
        mouse.x=(e.clientX/window.innerWidth)*2-1; mouse.y=-(e.clientY/window.innerHeight)*2+1;
        ray.setFromCamera(mouse,camera);
        const ints=ray.intersectObjects(tiles);
        if(ints.length && activeCardType) {
            const id=ints[0].object.userData.id;
            if(isHost) processAction({type:activeCardType, t:id, cIdx:selectedHandIdx}, 'X');
            else conn.send({type:'Action', act:{type:activeCardType, t:id, cIdx:selectedHandIdx}});
            selectedHandIdx=null; activeCardType=null; updateHandUI();
        }
    };

    function updateHandUI() {
        const c=document.getElementById('hand-container'); c.innerHTML='';
        GameState.hands[mySide].forEach((k,i)=>{
            const d=CARDS[k]; const el=document.createElement('div'); el.className=`card ${d.rarity} ${i===selectedHandIdx?'selected':''}`;
            el.innerHTML=`<div class="card-icon">${d.icon}</div><div class="card-name">${d.name}</div>`;
            el.onclick=()=>{if(GameState.turn===mySide){selectedHandIdx=i; activeCardType=k; updateHandUI();}}; 
            c.appendChild(el);
        });
    }

    function showToast(m,c) { const t=document.getElementById('toast-msg'); t.innerText=m; t.style.textShadow=`0 0 30px ${c}`; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
    function copyCode() { navigator.clipboard.writeText(document.getElementById('display-code').innerText); showToast("COPIADO", "#fff"); }
    function quitGame() { if(conn) conn.close(); location.reload(); }
    setInterval(()=>{ if(isInGame && !GameState.winner){ if(timeLeft>0) timeLeft-=0.1; document.getElementById('timer-bar').style.width=(timeLeft/16)*100+'%'; if(isHost && timeLeft<=0) processAction({type:'TIMEOUT'}, GameState.turn); } }, 100);

</script>
</body>
</html>